@model Toolify.ProductService.Models.Product

@{
    ViewData["Title"] = Model.Name;
    ViewData["ParentPage"] = "Каталог";
    ViewData["ParentLink"] = "/Home/Index";

    bool hasDiscount = Model.Discount > 0;
    bool isOutOfStock = Model.StockQuantity <= 0;
    decimal finalPrice = Model.Price;
    if (hasDiscount)
    {
        finalPrice = Model.Price - (Model.Price * Model.Discount / 100);
    }
}

<partial name="_Breadcrumbs" />
<div class="product-details-container">

    <div class="detail-image">
        <img src="https://localhost:7188@(Model.ImagePath)"
             alt="@Model.Name"
             onerror="this.onerror=null; this.src='/images/no-image.png';" />
    </div>

    <div class="detail-info">
        <h1 class="detail-title">@Model.Name</h1>

        <div class="detail-rating-row">
            <span class="stars">★</span>
            <span class="rating-value">0.0</span>
            <span class="reviews-count">0 отзывов</span>
            <span style="margin-left: 20px; color: #666; font-size: 0.9em;">
                Артикул: @Model.ArticleNumber
            </span>
        </div>

        <div class="action-buttons-row">
            <button class="btn-text-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                В избранное
            </button>

            <button class="btn-text-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                Сравнить
            </button>
        </div>

        <div class="detail-description">
            <h3>Описание</h3>
            <p>@Model.FullDescription</p>
        </div>
    </div>

   

    <div class="detail-buy-block product-card">
        <div class="price-wrap">
            <span class="main-price">@finalPrice.ToString("N2") Руб</span>
            @if (hasDiscount)
            {
                <span class="old-price">@Model.Price.ToString("N2") Руб</span>
                <span class="badge discount">-@Model.Discount%</span>
            }
        </div>

        @if (isOutOfStock)
        {
            <div class="stock out">Нет в наличии</div>
            <button class="btn-add-cart disabled" disabled>Нет в наличии</button>
        }
        else
        {
            <div class="stock in">В наличии</div>
            <button type="button"
                    class="btn-add-cart"
                    onclick="addToCartAnimated(event, @Model.Id, this)">
                Добавить в корзину
            </button>
        }
    </div>
</div>

@{
    var reviews = ViewBag.Reviews as List<HouseholdStore.Models.ReviewViewModel> ?? new List<HouseholdStore.Models.ReviewViewModel>();
    var avgRating = (double)(ViewBag.AverageRating ?? 0);
    var reviewsCount = (int)(ViewBag.ReviewsCount ?? 0);
    var starCounts = ViewBag.StarCounts as int[] ?? new int[6];
}

<div class="reviews-container">

    <div class="reviews-left-column">
        <h2 class="reviews-title">Отзывы о товаре (@reviewsCount)</h2>

        @if (!reviews.Any())
        {
            <p style="color: #777; margin-bottom: 20px;">Отзывов пока нет. Будьте первым!</p>
        }
        else
        {
            <div class="reviews-filters">
                <span class="filter-sort">Сортировать по: <a href="#" class="active">Дате</a> <a href="#">Рейтингу</a></span>
            </div>

            <div class="review-list">
                @foreach (var review in reviews)
                {
                    <div class="review-item">
                        <div class="review-header">
                            <div class="user-avatar"></div> <span class="user-name">@review.UserName</span>
                            <div class="stars-green">
                                @for (int i = 0; i < review.Rating; i++)
                                {
                                    <span>★</span>
                                }
                            </div>
                            <span style="font-size: 12px; color: #999; margin-left: auto;">@review.CreatedAt.ToString("dd.MM.yyyy")</span>
                        </div>
                        <div class="review-body">
                            @if (!string.IsNullOrEmpty(review.Pros))
                            {
                                <span class="comment-label">Достоинства:</span>
                                <p>@review.Pros</p>
                            }
                            @if (!string.IsNullOrEmpty(review.Cons))
                            {
                                <span class="comment-label" style="margin-top:10px;">Недостатки:</span>
                                <p>@review.Cons</p>
                            }
                            @if (!string.IsNullOrEmpty(review.Comment))
                            {
                                <span class="comment-label" style="margin-top:10px;">Комментарий:</span>
                                <p>@review.Comment</p>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <div class="reviews-right-column">
        <div class="rating-card">
            <h3 class="rating-title">Рейтинг покупателей</h3>

            <div class="rating-main-row">
                <div class="stars-green big">
                    @for (int i = 0; i < Math.Round(avgRating); i++)
                    {
                        <span>★</span>
                    }
                </div>
                <div class="rating-score">@avgRating.ToString("0.0") <span>/ 5</span></div>
            </div>

            <div class="rating-bars">
                @for (int i = 5; i >= 1; i--)
                {
                    var count = starCounts[i];
                    var percent = reviewsCount > 0 ? (double)count / reviewsCount * 100 : 0;
                    <div class="bar-row">
                        <span class="star-label">@i звезд</span>
                        <div class="progress-track">
                            <div class="progress-fill" style="width: @percent.ToString("0")%;"></div>
                        </div>
                        <span class="percent-label">@percent.ToString("0")%</span>
                    </div>
                }
            </div>

            <button class="btn-leave-review" onclick="openReviewModal()">
                Оставить свой отзыв
            </button>
        </div>
    </div>
</div>

<div id="reviewModal" class="modal-overlay">
    <div class="review-modal">
        <button class="modal-close" onclick="closeReviewModal()">×</button>
        <h3 class="modal-title">Ваш отзыв</h3>

        <form asp-controller="Home" asp-action="LeaveReview" method="post">
            <input type="hidden" name="ProductId" value="@Model.Id" />

            <div class="form-group" style="text-align: center;">
                <label class="form-label">Общая оценка</label>
                <input type="hidden" name="Rating" id="ratingInput" value="5" />
                <div class="star-rating-input" id="starContainer">
                    <span class="star-item active" data-value="1">★</span>
                    <span class="star-item active" data-value="2">★</span>
                    <span class="star-item active" data-value="3">★</span>
                    <span class="star-item active" data-value="4">★</span>
                    <span class="star-item active" data-value="5">★</span>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Достоинства</label>
                <input type="text" name="Pros" class="form-input" placeholder="Что вам понравилось" />
            </div>

            <div class="form-group">
                <label class="form-label">Недостатки</label>
                <input type="text" name="Cons" class="form-input" placeholder="Что не оправдало ожиданий" />
            </div>

            <div class="form-group">
                <label class="form-label">Комментарий</label>
                <textarea name="Comment" class="form-textarea" placeholder="Другие впечатления"></textarea>
            </div>

            <div class="user-row">
                <div class="form-group">
                    <label class="form-label">Как вас зовут</label>
                    <input type="text" name="UserName" class="form-input" required
                           value="@(User.Identity.IsAuthenticated? User.Identity.Name : "")" />
                </div>
                <div class="form-group">
                    <label class="form-label">Ваш e-mail</label>
                    <input type="email" name="UserEmail" class="form-input" required
                           value="@(User.Identity.IsAuthenticated? User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value : "")" />
                </div>
            </div>

            <button type="submit" class="btn-submit-review">Отправить отзыв</button>
        </form>
    </div>
</div>

@section Scripts {
    <script src="~/js/product-reviews.js" asp-append-version="true"></script>
}